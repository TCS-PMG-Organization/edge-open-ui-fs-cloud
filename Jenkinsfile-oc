pipeline {
  agent any
  
  environment {
    LOGIN_URL = 'https://c108-e.eu-gb.containers.cloud.ibm.com'
    LOGIN_PORT = '32125'
    PROJECT = 'edge-banking-pipeline'
  }  
  stages {
    stage ('Initialize') {
      steps {
        sh '''
          echo "PATH = ${PATH}"
          echo "M2_HOME = ${M2_HOME}"
        ''' 
      }
    }
   
    stage('Preamble') {
      steps {
        script {
          openshift.withCluster() {
            openshift.withProject("${env.PROJECT}") {
              echo "Using project: ${openshift.project()}"
            }
          }
        }
      }
    }  
   
    stage('Delete') {
      steps {
        echo "Delete application"
        script {
          openshift.withCluster() {
            openshift.withProject("${env.PROJECT}") {
              openshift.selector("all", [  'app' : 'edge-banking-pipeline' ]).delete()
            }
          }
        }
      }
    }
    stage('Deploy') {
      steps {
        echo 'Deploy application'
        script {
          sh 'oc new-app registry.access.redhat.com/ubi7/nodejs-14~https://github.com/chongdershubhayu/openshift-python-sample.git#main --name edge-banking-pipeline  --as-deployment-config'
        }

      }
    }
    stage('Expose') {
      steps {
        echo 'Expose Route'
        
        script {
          sh 'oc expose dc edge-banking-pipeline --type=LoadBalancer --name=edge-banking-pipeline-svc2 --port=3000'
          sh 'oc expose svc edge-banking-pipeline-svc2'
        }

      }
    }
  }
}
